// Multi-tenant SaaS Application Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Tenant (Organization) Model
model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  domain      String?
  plan        Plan     @default(FREE)
  status      TenantStatus @default(ACTIVE)
  maxUsers    Int      @default(5)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       TenantUser[]
  projects    Project[]
  invitations Invitation[]
  subscriptions Subscription[]
  usageStats  UsageStats[]
  sessions    Session[]

  @@map("tenants")
}

// User Model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  avatar    String?
  password  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Security Questions
  securityQuestion1  String?
  securityAnswer1   String?
  securityQuestion2  String?
  securityAnswer2   String?
  securityQuestion3  String?
  securityAnswer3   String?

  // Relations
  tenantUsers TenantUser[]
  invitationsSent Invitation[] @relation("InvitationSent")
  invitationsReceived Invitation[] @relation("InvitationReceived")
  sessions    Session[]

  @@map("users")
}

// Tenant-User Relationship (Membership)
model TenantUser {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      UserRole @default(MEMBER)
  joinedAt  DateTime @default(now())
  isActive  Boolean  @default(true)

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects   Project[]
  assigned   Task[]   @relation("TaskAssigned")
  created    Task[]   @relation("TaskCreated")

  @@unique([userId, tenantId])
  @@map("tenant_users")
}

// Project Model (Tenant-scoped)
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  tenantId    String
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy TenantUser @relation(fields: [createdById], references: [id])
  tasks     Task[]

  @@map("projects")
}

// Task Model (Project-scoped)
model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  projectId   String
  assignedId  String?
  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigned  TenantUser? @relation("TaskAssigned", fields: [assignedId], references: [id])
  createdBy TenantUser @relation("TaskCreated", fields: [createdById], references: [id])

  @@map("tasks")
}

// Invitation Model
model Invitation {
  id       String           @id @default(cuid())
  email    String
  role     UserRole         @default(MEMBER)
  token    String           @unique
  status   InvitationStatus @default(PENDING)
  tenantId String
  invitedById String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invitedBy  User   @relation("InvitationSent", fields: [invitedById], references: [id])
  invitedUser User?  @relation("InvitationReceived", fields: [email], references: [email])

  @@unique([email, tenantId])
  @@map("invitations")
}

// Subscription Model
model Subscription {
  id          String          @id @default(cuid())
  tenantId    String
  plan        Plan
  status      SubscriptionStatus @default(ACTIVE)
  startDate   DateTime
  endDate     DateTime?
  amount      Float?
  currency    String          @default("USD")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Usage Statistics Model
model UsageStats {
  id        String   @id @default(cuid())
  tenantId  String
  metric    String
  value     Int
  date      DateTime
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric, date])
  @@map("usage_stats")
}

// Session Model for NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  tenantId     String?
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@map("sessions")
}

// Enums
enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}