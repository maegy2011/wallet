// Prisma Schema with Enhanced Notifications System (Fixed for SQLite)
// نسخة مصححة بدون arrays

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums

enum PlanType {
  FREE
  MERCHANT
}

enum UserRole {
  TENANT_OWNER
  COMPANY_MANAGER
  BRANCH_MANAGER
  SUPERVISOR
  EMPLOYEE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum InvoiceType {
  ONE_TIME
  RECURRING
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  PENDING
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ReportType {
  INVOICE_SUMMARY
  PAYMENT_SUMMARY
  REVENUE
  EXPENSE
  PROFIT_LOSS
  CASH_FLOW
  AGING_REPORT
  CUSTOMER_BALANCE
  SUBSCRIPTION_METRICS
  FINANCIAL_ANALYSIS
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
  SCHEDULED
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
}

enum ChartType {
  BAR
  LINE
  PIE
  AREA
  SCATTER
}

// Notification Enums

enum NotificationType {
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_OVERDUE
  INVOICE_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PAYMENT_REFUNDED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_EXPIRED
  SUBSCRIPTION_TRIAL_ENDING
  TRANSACTION_CREATED
  TRANSACTION_UPDATED
  WALLET_BALANCE_LOW
  REPORT_GENERATED
  REPORT_FAILED
  SYSTEM_MAINTENANCE
  SYSTEM_UPDATE
  SYSTEM_ERROR
  WELCOME
  SECURITY_ALERT
  DATA_EXPORTED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  SCHEDULED
  PENDING
  SENT
  FAILED
  READ
  DISMISSED
}

enum NotificationCategory {
  GENERAL
  INVOICES
  PAYMENTS
  SUBSCRIPTIONS
  TRANSACTIONS
  REPORTS
  SYSTEM
  SECURITY
}

// Models

model Tenant {
  id              String  @id @default(cuid())
  name            String
  email           String  @unique
  phone           String?
  businessName    String?
  businessLicense String?
  isActive        Boolean @default(true)

  // Subscription
  plan                  PlanType  @default(FREE)
  subscriptionEnd       DateTime?
  autoRenewSubscription Boolean   @default(true)
  trialEndDate          DateTime?
  subscriptionId        String?

  // Relations
  users                   User[]
  companies               Company[]
  partners                Partner[]
  wallets                 Wallet[]
  categories              Category[]
  transactions            Transaction[]
  invoices                Invoice[]
  payments                Payment[]
  subscriptions           Subscription[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  reports                 Report[]
  financialAnalyses       FinancialAnalysis[]

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  invoiceItems          InvoiceItem[]
  notificationTemplates NotificationTemplate[]
  notificationQueues    NotificationQueue[]

  @@index([email])
  @@index([subscriptionId])
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String?
  phone                   String?
  password                String?
  role                    UserRole                 @default(EMPLOYEE)
  isActive                Boolean                  @default(true)
  lastLoginAt             DateTime?
  lastLoginIP             String?
  loginAttempts           Int                      @default(0)
  lockedUntil             DateTime?
  emailVerified           Boolean                  @default(false)
  emailVerifiedAt         DateTime?
  verificationToken       String?
  resetToken              String?
  resetTokenExpiry        DateTime?
  twoFactorEnabled        Boolean                  @default(false)
  twoFactorSecret         String?
  tenantId                String
  tenant                  Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId               String?
  company                 Company?                 @relation(fields: [companyId], references: [id])
  branchId                String?
  branch                  Branch?                  @relation(fields: [branchId], references: [id])
  transactions            Transaction[]
  invoices                Invoice[]
  payments                Payment[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  subscriptions           Subscription[]
  notificationQueues      NotificationQueue[]
  reports                 Report[]
  financialAnalyses       FinancialAnalysis[]

  @@index([tenantId])
  @@index([companyId])
  @@index([branchId])
  @@index([email])
  @@index([tenantId, email])
}

model Company {
  id                String              @id @default(cuid())
  name              String
  description       String?
  taxId             String?
  isActive          Boolean             @default(true)
  tenantId          String
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branches          Branch[]
  users             User[]
  invoices          Invoice[]
  payments          Payment[]
  reports           Report[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  financialAnalyses FinancialAnalysis[]

  @@index([tenantId])
}

model Branch {
  id                String              @id @default(cuid())
  name              String
  address           String?
  phone             String?
  isActive          Boolean             @default(true)
  companyId         String
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users             User[]
  wallets           Wallet[]
  reports           Report[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  invoices          Invoice[]
  payments          Payment[]
  financialAnalyses FinancialAnalysis[]

  @@index([companyId])
}

model Partner {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  company   String?
  role      String?
  notes     String?
  isActive  Boolean  @default(true)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Wallet {
  id           String        @id @default(cuid())
  name         String
  description  String?
  balance      Float         @default(0)
  currency     String        @default("USD")
  type         String        @default("general")
  icon         String        @default("wallet")
  color        String        @default("primary")
  isActive     Boolean       @default(true)
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branchId     String?
  branch       Branch?       @relation(fields: [branchId], references: [id])
  transactions Transaction[]
  invoices     Invoice[]
  payments     Payment[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
  @@index([branchId])
}

model Category {
  id           String        @id @default(cuid())
  name         String
  description  String?
  type         String
  icon         String?
  color        String?
  isActive     Boolean       @default(true)
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invoices     Invoice[]
  invoiceItems InvoiceItem[]
  payments     Payment[]

  @@index([tenantId])
}

model Transaction {
  id          String    @id @default(cuid())
  title       String
  description String?
  amount      Float
  type        String
  date        DateTime  @default(now())
  status      String    @default("completed")
  tags        String?
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  walletId    String
  wallet      Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  createdById String?
  createdBy   User?     @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
  @@index([walletId])
  @@index([date])
}

model Invoice {
  id               String         @id @default(cuid())
  invoiceNumber    String         @unique
  type             InvoiceType    @default(ONE_TIME)
  status           InvoiceStatus  @default(DRAFT)
  clientId         String
  clientName       String
  clientEmail      String?
  clientPhone      String?
  clientAddress    String?
  clientTaxId      String?
  title            String
  description      String?
  notes            String?
  currency         String         @default("USD")
  issueDate        DateTime       @default(now())
  dueDate          DateTime       @default(now())
  paidDate         DateTime?
  reminderDate     DateTime?
  subtotal         Float          @default(0)
  taxAmount        Float          @default(0)
  discountAmount   Float          @default(0)
  total            Float          @default(0)
  amountPaid       Float          @default(0)
  balance          Float          @default(0)
  processedAt      DateTime?
  processingStatus String?
  tenantId         String
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId        String?
  company          Company?       @relation(fields: [companyId], references: [id])
  branchId         String?
  branch           Branch?        @relation(fields: [branchId], references: [id])
  walletId         String
  wallet           Wallet         @relation(fields: [walletId], references: [id])
  categoryId       String?
  category         Category?      @relation(fields: [categoryId], references: [id])
  items            InvoiceItem[]
  payments         Payment[]
  subscriptions    Subscription[]
  createdBy        String?
  createdByUser    User?          @relation(fields: [userId], references: [id])
  isOffline        Boolean        @default(false)
  syncedAt         DateTime?
  syncedDeviceId   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  userId           String?
  notifications    Notification[]

  @@index([tenantId])
  @@index([companyId])
  @@index([branchId])
  @@index([walletId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
}

model InvoiceItem {
  id          String    @id @default(cuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float     @default(1)
  unitPrice   Float
  discount    Float     @default(0)
  total       Float     @default(0)
  itemId      String?
  itemName    String?
  sku         String?
  taxRate     Float?    @default(0)
  notes       String?
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([invoiceId])
  @@index([tenantId])
}

model Payment {
  id             String         @id @default(cuid())
  paymentNumber  String         @unique
  invoiceId      String?
  invoice        Invoice?       @relation(fields: [invoiceId], references: [id])
  amount         Float
  currency       String         @default("USD")
  paymentMethod  PaymentMethod
  status         PaymentStatus  @default(PENDING)
  transactionId  String?
  gateway        String?
  payerName      String?
  payerEmail     String?
  payerPhone     String?
  payerAddress   String?
  payerTaxId     String?
  processedAt    DateTime?
  failedReason   String?
  refundedAt     DateTime?
  refundAmount   Float          @default(0)
  refundReason   String?
  tenantId       String
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId      String?
  company        Company?       @relation(fields: [companyId], references: [id])
  branchId       String?
  branch         Branch?        @relation(fields: [branchId], references: [id])
  walletId       String
  wallet         Wallet         @relation(fields: [walletId], references: [id])
  categoryId     String?
  category       Category?      @relation(fields: [categoryId], references: [id])
  createdBy      String?
  createdByUser  User?          @relation(fields: [createdBy], references: [id])
  isOffline      Boolean        @default(false)
  syncedAt       DateTime?
  syncedDeviceId String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  subscription   Subscription?  @relation(fields: [subscriptionId], references: [id])
  subscriptionId String?
  notifications  Notification[]

  @@index([tenantId])
  @@index([invoiceId])
  @@index([walletId])
  @@index([status])
  @@index([paymentNumber])
}

model Subscription {
  id                 String             @id @default(cuid())
  planType           PlanType           @default(FREE)
  planName           String
  planDescription    String?
  maxUsers           Int                @default(1)
  maxTransactions    Int                @default(100)
  maxWallets         Int                @default(5)
  maxCategories      Int                @default(20)
  features           String?
  cycle              BillingCycle       @default(MONTHLY)
  price              Float              @default(0)
  currency           String             @default("USD")
  taxRate            Float              @default(0)
  discountAmount     Float              @default(0)
  discountPercent    Float              @default(0)
  totalPrice         Float              @default(0)
  startDate          DateTime           @default(now())
  endDate            DateTime
  trialEndDate       DateTime?
  nextBillingDate    DateTime
  lastBillingDate    DateTime?
  paymentMethod      PaymentMethod?     @default(BANK_TRANSFER)
  autoRenew          Boolean            @default(true)
  status             SubscriptionStatus @default(TRIAL)
  isActive           Boolean            @default(true)
  cancelledAt        DateTime?
  cancellationReason String?
  isOffline          Boolean            @default(false)
  lastSyncedAt       DateTime?
  syncedDeviceId     String?
  tenantId           String
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments           Payment[]
  invoices           Invoice[]
  notifications      Notification[]
  createdBy          String?
  createdByUser      User?              @relation(fields: [userId], references: [id])
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  userId             String?

  @@index([tenantId])
  @@index([status])
  @@index([nextBillingDate])
  @@index([planType])
}

// Notification Models

model NotificationPreference {
  id       String @id @default(cuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Channel Preferences
  inAppNotifications Boolean @default(true)
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)
  smsNotifications   Boolean @default(false)

  // Category Preferences
  generalEnabled       Boolean @default(true)
  invoicesEnabled      Boolean @default(true)
  paymentsEnabled      Boolean @default(true)
  subscriptionsEnabled Boolean @default(true)
  transactionsEnabled  Boolean @default(true)
  reportsEnabled       Boolean @default(true)
  systemEnabled        Boolean @default(true)
  securityEnabled      Boolean @default(true)

  // Frequency Preferences
  emailFrequency String @default("real-time")
  pushFrequency  String @default("real-time")

  // Quiet Hours
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?

  // Additional Settings
  soundEnabled     Boolean @default(true)
  vibrationEnabled Boolean @default(true)
  desktopEnabled   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([tenantId])
}

model Notification {
  id String @id @default(cuid())

  // Type & Priority
  type     NotificationType
  category NotificationCategory @default(GENERAL)
  priority NotificationPriority @default(NORMAL)
  status   NotificationStatus   @default(SCHEDULED)

  // Title & Message
  title     String
  message   String
  link      String?
  thumbnail String?
  data      String?

  // Delivery Channels
  channels     String  @default("IN_APP")
  sentViaInApp Boolean @default(false)
  sentViaEmail Boolean @default(false)
  sentViaPush  Boolean @default(false)
  sentViaSMS   Boolean @default(false)

  // Read & Dismiss Status
  isRead      Boolean   @default(false)
  readAt      DateTime?
  isDismissed Boolean   @default(false)
  dismissedAt DateTime?

  // Expiration
  expiresAt DateTime?

  // Actionable
  actionType  String?
  actionId    String?
  actionLabel String?
  actionUrl   String?

  // Tenant & User
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Related Entities
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  invoiceId      String?
  invoice        Invoice?      @relation(fields: [invoiceId], references: [id])
  paymentId      String?
  payment        Payment?      @relation(fields: [paymentId], references: [id])

  // Offline Sync
  isOffline      Boolean   @default(false)
  syncedAt       DateTime?
  syncedDeviceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationTemplate {
  id String @id @default(cuid())

  // Template Identification
  name     String               @unique
  type     NotificationType
  category NotificationCategory @default(GENERAL)

  // Default Content
  title           String
  message         String
  actionType      String?
  actionLabel     String?
  defaultPriority NotificationPriority @default(NORMAL)

  // Channels to use by default
  defaultChannels String @default("IN_APP,EMAIL")

  // Customization
  isCustomizable Boolean @default(true)
  variables      String?

  // Delivery Settings
  emailTemplate String?
  pushPayload   String?

  // Availability
  isActive Boolean @default(true)
  tenantId String? // null = system-wide, tenantId = tenant-specific
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([isActive])
}

model NotificationQueue {
  id String @id @default(cuid())

  // Notification Content
  type        NotificationType
  category    NotificationCategory @default(GENERAL)
  priority    NotificationPriority @default(NORMAL)
  title       String
  message     String
  data        String?
  link        String?
  actionType  String?
  actionId    String?
  actionLabel String?

  // Target Audience
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId   String? // null = all users, string = specific user
  user     User?   @relation(fields: [userId], references: [id])

  // Schedule
  scheduledAt DateTime  @default(now())
  sentAt      DateTime?
  expiresAt   DateTime?

  // Status
  status      NotificationStatus @default(SCHEDULED)
  attempts    Int                @default(0)
  maxAttempts Int                @default(3)
  lastError   String?

  // Processing
  processedBy    String?
  processedAt    DateTime?
  processingTime Int? // processing time in ms

  // Offline Sync
  isOffline      Boolean   @default(false)
  syncedAt       DateTime?
  syncedDeviceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
  @@index([priority])
}

model Report {
  id           String       @id @default(cuid())
  reportNumber String       @unique
  type         ReportType
  status       ReportStatus @default(GENERATING)
  format       ReportFormat @default(PDF)

  // Report Details
  title       String
  description String?
  parameters  String?

  // Date Range
  startDate DateTime
  endDate   DateTime

  // Metrics
  totalRevenue    Float @default(0)
  totalExpenses   Float @default(0)
  netProfit       Float @default(0)
  grossProfit     Float @default(0)
  averageRevenue  Float @default(0)
  averageExpenses Float @default(0)

  // Charts
  chartType ChartType?
  chartData String?

  // Output
  filePath      String?
  fileSize      Float?
  downloadCount Int     @default(0)

  // Processing
  generatedAt    DateTime?
  processingTime Int?

  // Offline Processing
  isOffline      Boolean   @default(false)
  syncedAt       DateTime?
  syncedDeviceId String?

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  createdBy     String?
  createdByUser User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String?

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([reportNumber])
}

model FinancialAnalysis {
  id String @id @default(cuid())

  // Analysis Details
  title        String
  description  String?
  analysisType String

  // Date Range
  startDate DateTime
  endDate   DateTime

  // Revenue Metrics
  totalRevenue   Float   @default(0)
  averageRevenue Float   @default(0)
  revenueGrowth  Float?
  revenueTrend   String?

  // Expense Metrics
  totalExpenses   Float   @default(0)
  averageExpenses Float   @default(0)
  expenseGrowth   Float?
  expenseTrend    String?

  // Profit Metrics
  netProfit       Float   @default(0)
  grossProfit     Float   @default(0)
  profitMargin    Float?
  profitLossTrend String?

  // Cash Flow Metrics
  cashInflow    Float   @default(0)
  cashOutflow   Float   @default(0)
  netCashFlow   Float   @default(0)
  cashFlowTrend String?

  // Customer Metrics
  totalCustomers    Int    @default(0)
  activeCustomers   Int    @default(0)
  customerRetention Float?

  // Invoice Metrics
  totalInvoices        Int    @default(0)
  paidInvoices         Int    @default(0)
  overdueInvoices      Int    @default(0)
  averageInvoiceAmount Float  @default(0)
  collectionRate       Float?

  // Payment Metrics
  totalPayments        Int    @default(0)
  onTimePayments       Int    @default(0)
  latePayments         Int    @default(0)
  averagePaymentAmount Float  @default(0)
  paymentSuccessRate   Float?

  // Subscription Metrics
  totalSubscriptions  Int    @default(0)
  activeSubscriptions Int    @default(0)
  churnRate           Float?
  lifetimeValue       Float?

  // Visualizations
  charts          String?
  insights        String?
  recommendations String?

  // Offline Processing
  isOffline      Boolean   @default(false)
  lastSyncedAt   DateTime?
  syncedDeviceId String?

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  createdBy     String?
  createdByUser User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String?

  @@index([tenantId])
  @@index([companyId])
  @@index([branchId])
  @@index([startDate])
  @@index([endDate])
  @@index([analysisType])
}
