'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Badge } from '@/components/ui/badge'
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { 
  Users, 
  UserPlus, 
  Edit, 
  Trash2, 
  ArrowRight, 
  ArrowLeft, 
  Shield, 
  Building,
  Search,
  Filter,
  Download,
  Upload,
  Eye,
  EyeOff,
  Check,
  X,
  AlertTriangle,
  RefreshCw
} from 'lucide-react' from 'lucide-react'

interface User {
  id: string
  username: string
  email?: string
  phone: string
  nationalId: string
  isActive: boolean
  createdAt: string
  userRoles: Array<{
    id: string
    role: {
      id: string
      name: string
      description: string
      permissions: string
    }
    businessAccount?: {
      id: string
      name: string
    }
    branch?: {
      id: string
      name: string
    }
  }>
}

interface Branch {
  id: string
  name: string
  isActive: boolean
}

interface Role {
  id: string
  name: string
  description: string
  permissions: string
}

interface Permission {
  id: string
  name: string
  description: string
  checked: boolean
}

const PERMISSIONS = [
  { id: 'can_manage_wallets', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸', description: 'Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø­Ø§ÙØ¸' },
  { id: 'can_manage_transactions', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', description: 'Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©' },
  { id: 'can_manage_expenses', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', description: 'Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' },
  { id: 'can_manage_reports', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', description: 'Ø¹Ø±Ø¶ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©' },
  { id: 'can_manage_branches', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹', description: 'Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„ÙØ±ÙˆØ¹' },
  { id: 'can_manage_users', name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', description: 'Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' },
  { id: 'can_view_all_data', name: 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', description: 'Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©' },
]

export default function UserManagement() {
  const [users, setUsers] = useState<User[]>([])
  const [branches, setBranches] = useState<Branch[]>([])
  const [roles, setRoles] = useState<Role[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState('')
  const [success, setSuccess] = useState('')
  const [selectedUser, setSelectedUser] = useState<User | null>(null)
  const [showAddUser, setShowAddUser] = useState(false)
  const [showEditUser, setShowEditUser] = useState(false)
  const [showDeleteDialog, setShowDeleteDialog] = useState(false)
  const [userToDelete, setUserToDelete] = useState<User | null>(null)
  const [showRoleDialog, setShowRoleDialog] = useState(false)
  const [selectedUserForRole, setSelectedUserForRole] = useState<User | null>(null)
  const [showTransferDialog, setShowTransferDialog] = useState(false)
  const [userToTransfer, setUserToTransfer] = useState<User | null>(null)
  const [selectedBranchForTransfer, setSelectedBranchForTransfer] = useState<Branch | null>(null)
  const [searchTerm, setSearchTerm] = useState('')
  const [activeTab, setActiveTab] = useState('all')
  const [selectedPermissions, setSelectedPermissions] = useState<string[]>([])
  
  // Form states
  const [userForm, setUserForm] = useState({
    username: '',
    email: '',
    phone: '',
    nationalId: '',
    password: '',
    confirmPassword: ''
  })
  
  const [editForm, setEditForm] = useState({
    username: '',
    email: '',
    phone: '',
    nationalId: ''
  })

  const router = useRouter()

  // Check authentication
  useEffect(() => {
    const token = localStorage.getItem('authToken')
    const userData = localStorage.getItem('user')
    const businessData = localStorage.getItem('businessAccounts')
    
    if (!token || !userData) {
      router.push('/auth/login')
      return
    }

    const businessAccounts = businessData ? JSON.parse(businessData) : []
    if (businessAccounts.length === 0) {
      router.push('/business/register')
      return
    }

    loadData()
  }, [])

  const loadData = async () => {
    try {
      const token = localStorage.getItem('authToken')
      const businessData = localStorage.getItem('businessAccounts')
      const businessAccounts = businessData ? JSON.parse(businessData) : []
      
      if (businessAccounts.length > 0) {
        const [usersResponse, branchesResponse, rolesResponse] = await Promise.all([
          fetch(`/api/business/users?businessAccountId=${businessAccounts[0].id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`/api/business/branches?businessAccountId=${businessAccounts[0].id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`/api/business/roles?businessAccountId=${businessAccounts[0].id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ])

        if (usersResponse.ok && branchesResponse.ok && rolesResponse.ok) {
          const [usersData, branchesData, rolesData] = await Promise.all([
            usersResponse.json(),
            branchesResponse.json(),
            rolesResponse.json()
          ])
          setUsers(usersData.users || [])
          setBranches(branchesData.branches || [])
          setRoles(rolesData.roles || [])
        } else {
          setError('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
        }
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    } finally {
      setIsLoading(false)
    }
  }

  const handleAddUser = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (userForm.password !== userForm.confirmPassword) {
      setError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†')
      return
    }

    try {
      const token = localStorage.getItem('authToken')
      const businessData = localStorage.getItem('businessAccounts')
      const businessAccounts = businessData ? JSON.parse(businessData) : []
      
      if (businessAccounts.length === 0) {
        setError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´Ø£Ø© ØªØ¬Ø§Ø±ÙŠØ©')
        return
      }

      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: userForm.username,
          email: userForm.email,
          phone: userForm.phone,
          nationalId: userForm.nationalId,
          password: userForm.password
        }),
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
        setShowAddUser(false)
        setUserForm({ username: '', email: '', phone: '', nationalId: '', password: '', confirmPassword: '' })
        
        // Assign default seller role and link to business
        await assignUserToBusiness(data.user.id, businessAccounts[0].id)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const handleEditUser = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!selectedUser) return
    
    try {
      const token = localStorage.getItem('authToken')
      
      const response = await fetch(`/api/business/users/${selectedUser.id}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(editForm),
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
        setShowEditUser(false)
        setSelectedUser(null)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const handleDeleteUser = async () => {
    if (!userToDelete) return
    
    try {
      const token = localStorage.getItem('authToken')
      
      const response = await fetch(`/api/business/users/${userToDelete.id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
        setShowDeleteDialog(false)
        setUserToDelete(null)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const handleToggleUserStatus = async (userId: string, currentStatus: boolean) => {
    try {
      const token = localStorage.getItem('authToken')
      
      const response = await fetch(`/api/business/users/${userId}/toggle-status`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess(`ØªÙ… ${currentStatus ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const assignUserToBusiness = async (userId: string, businessAccountId: string) => {
    try {
      const token = localStorage.getItem('authToken')
      
      // Get seller role (default role for new users)
      const rolesResponse = await fetch(`/api/business/roles?businessAccountId=${businessAccountId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })

      if (rolesResponse.ok) {
        const rolesData = await rolesResponse.json()
        const sellerRole = rolesData.roles?.find((role: Role) => 
          role.name.includes('seller') || role.name.includes('Ø¨Ø§Ø¦Ø¹')
        )

        if (sellerRole) {
          await fetch('/api/business/users/assign-role', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId,
              businessAccountId,
              roleId: sellerRole.id
            }),
          })
        }
      }
    } catch (error) {
      console.error('Error assigning user to business:', error)
    }
  }

  const handleAssignRole = async () => {
    if (!selectedUserForRole) return
    
    try {
      const token = localStorage.getItem('authToken')
      const businessData = localStorage.getItem('businessAccounts')
      const businessAccounts = businessData ? JSON.parse(businessData) : []
      
      if (businessAccounts.length === 0) return

      const response = await fetch('/api/business/users/assign-role', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: selectedUserForRole.id,
          businessAccountId: businessAccounts[0].id,
          roleId: selectedUserForRole.userRoles[0]?.role?.id || ''
        }),
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­')
        setShowRoleDialog(false)
        setSelectedUserForRole(null)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const handleTransferUser = async () => {
    if (!userToTransfer || !selectedBranchForTransfer) return
    
    try {
      const token = localStorage.getItem('authToken')
      
      const response = await fetch('/api/business/users/transfer', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userToTransfer.id,
          fromBranchId: userToTransfer.userRoles[0]?.branch?.id,
          toBranchId: selectedBranchForTransfer.id
        }),
      })

      const data = await response.json()
      
      if (response.ok) {
        setSuccess(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userToTransfer.username} Ø¥Ù„Ù‰ ÙØ±Ø¹ ${selectedBranchForTransfer.name} Ø¨Ù†Ø¬Ø§Ø­`)
        setShowTransferDialog(false)
        setUserToTransfer(null)
        setSelectedBranchForTransfer(null)
        loadData()
      } else {
        setError(data.error || 'ÙØ´Ù„ ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    } catch (error) {
      setError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')
    }
  }

  const openEditDialog = (user: User) => {
    setSelectedUser(user)
    setEditForm({
      username: user.username,
      email: user.email || '',
      phone: user.phone,
      nationalId: user.nationalId
    })
    setShowEditUser(true)
  }

  const openDeleteDialog = (user: User) => {
    setUserToDelete(user)
    setShowDeleteDialog(true)
  }

  const openRoleDialog = (user: User) => {
    setSelectedUserForRole(user)
    setShowRoleDialog(true)
  }

  const openTransferDialog = (user: User) => {
    setUserToTransfer(user)
    setShowTransferDialog(true)
  }

  const getUserRole = (user: User) => {
    const merchantRole = user.userRoles.find(role => 
      role.role.name.includes('merchant') || role.role.name.includes('ØªØ§Ø¬Ø±')
    )
    const sellerRole = user.userRoles.find(role => 
      role.role.name.includes('seller') || role.role.name.includes('Ø¨Ø§Ø¦Ø¹')
    )
    
    if (merchantRole) return { name: 'ØªØ§Ø¬Ø±', color: 'bg-purple-100 text-purple-800' }
    if (sellerRole) return { name: 'Ø¨Ø§Ø¦Ø¹', color: 'bg-blue-100 text-blue-800' }
    return { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', color: 'bg-gray-100 text-gray-800' }
  }

  const getUserBranch = (user: User) => {
    return user.userRoles.find(role => role.branch)?.branch?.name || 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'
  }

  const getActiveBranches = () => branches.filter(b => b.isActive)
  const getInactiveBranches = () => branches.filter(b => !b.isActive)

  const filteredUsers = users.filter(user => {
    const matchesSearch = user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         user.phone.includes(searchTerm)
    
    if (activeTab === 'all') return matchesSearch
    if (activeTab === 'active') return matchesSearch && user.isActive
    if (activeTab === 'inactive') return matchesSearch && !user.isActive
    
    return false
  })

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="container mx-auto px-4 max-w-7xl">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                <Users className="h-8 w-8 text-blue-600" />
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
              </h1>
              <p className="text-gray-600 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ÙØ±ÙˆØ¹</p>
            </div>
            <div className="flex gap-3">
              <Link href="/">
                <Button variant="outline" className="flex items-center gap-2">
                  <Building className="h-4 w-4" />
                  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </Button>
              </Link>
              <Link href="/branches">
                <Button variant="outline" className="flex items-center gap-2">
                  <Building className="h-4 w-4" />
                  Ø§Ù„ÙØ±ÙˆØ¹
                </Button>
              </Link>
              <Button 
                onClick={() => setShowAddUser(true)}
                className="flex items-center gap-2"
              >
                <UserPlus className="h-4 w-4" />
                Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
              </Button>
            </div>
          </div>
        </div>

        {/* Alert Messages */}
        {error && (
          <Alert className="mb-6 border-red-200 bg-red-50">
            <AlertTriangle className="h-4 w-4" />
            <AlertDescription className="text-red-800">{error}</AlertDescription>
          </Alert>
        )}

        {success && (
          <Alert className="mb-6 border-green-200 bg-green-50">
            <AlertDescription className="text-green-800">{success}</AlertDescription>
          </Alert>
        )}

        {/* Statistics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{users.length}</div>
              <p className="text-xs text-muted-foreground">Ù…Ø³ØªØ®Ø¯Ù…</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</CardTitle>
              <div className="h-4 w-4 text-green-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">{users.filter(u => u.isActive).length}</div>
              <p className="text-xs text-muted-foreground">Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</CardTitle>
              <div className="h-4 w-4 text-orange-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-orange-600">{users.filter(u => !u.isActive).length}</div>
              <p className="text-xs text-muted-foreground">Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù†Ø´Ø·</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆØ¹</CardTitle>
              <Building className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{branches.length}</div>
              <p className="text-xs text-muted-foreground">ÙØ±Ø¹</p>
            </CardContent>
          </Card>
        </div>

        {/* Search and Filter */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex gap-4">
              <div className="flex-1">
                <div className="relative">
                  <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                  <Input
                    placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pr-10 text-right"
                  />
                </div>
              </div>
            </div>
            
            <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="all">Ø§Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</TabsTrigger>
                <TabsTrigger value="active">Ø§Ù„Ù†Ø´Ø·ÙˆÙ† ÙÙ‚Ø·</TabsTrigger>
                <TabsTrigger value="inactive">ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</TabsTrigger>
              </TabsList>
            </Tabs>
          </CardContent>
        </Card>

        {/* Users List */}
        <Card>
          <CardHeader>
            <CardTitle>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</CardTitle>
            <CardDescription>
              {filteredUsers.length} Ù…Ø³ØªØ®Ø¯Ù… {activeTab === 'all' && 'Ù…Ø±Ø´Ø­'} 
              {activeTab === 'active' && 'Ù†Ø´Ø·'} 
              {activeTab === 'inactive' && 'ØºÙŠØ± Ù†Ø´Ø·'}
            </CardDescription>
          </CardHeader>
          <CardContent>
            {filteredUsers.length === 0 ? (
              <div className="text-center py-8">
                <Users className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <p className="text-gray-500">
                  {searchTerm ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†'}
                </p>
              </div>
            ) : (
              <div className="space-y-4">
                {filteredUsers.map((user) => {
                  const role = getUserRole(user)
                  return (
                    <div key={user.id} className="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h3 className="text-lg font-semibold">{user.username}</h3>
                            <Badge className={role.color}>
                              {role.name}
                            </Badge>
                            {user.isActive ? (
                              <Badge className="bg-green-100 text-green-800">
                                Ù†Ø´Ø·
                              </Badge>
                            ) : (
                              <Badge className="bg-red-100 text-red-800">
                                ØºÙŠØ± Ù†Ø´Ø·
                              </Badge>
                            )}
                          </div>
                          
                          <div className="space-y-1 text-sm text-gray-600">
                            <div>ğŸ“§ {user.email || user.phone}</div>
                            <div>ğŸ†” {user.nationalId}</div>
                            <div>ğŸ¢ {getUserBranch(user)}</div>
                            <div>ğŸ“… {new Date(user.createdAt).toLocaleDateString('ar-EG')}</div>
                          </div>
                        </div>
                        
                        <div className="flex gap-2">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => openRoleDialog(user)}
                            className="flex items-center gap-1"
                          >
                            <Shield className="h-3 w-3" />
                            Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => openTransferDialog(user)}
                            className="flex items-center gap-1"
                          >
                            <ArrowRight className="h-3 w-3" />
                            Ù†Ù‚Ù„
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => openEditDialog(user)}
                            className="flex items-center gap-1"
                          >
                            <Edit className="h-3 w-3" />
                            ØªØ¹Ø¯ÙŠÙ„
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => handleToggleUserStatus(user.id, user.isActive)}
                            className={`flex items-center gap-1 ${
                              user.isActive 
                                ? 'text-orange-600 hover:text-orange-700' 
                                : 'text-green-600 hover:text-green-700'
                            }`}
                          >
                            {user.isActive ? (
                              <>
                                <EyeOff className="h-3 w-3" />
                                ØªØ¹Ø·ÙŠÙ„
                              </>
                            ) : (
                              <>
                                <Eye className="h-3 w-3" />
                                ØªÙØ¹ÙŠÙ„
                              </>
                            )}
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => openDeleteDialog(user)}
                            className="flex items-center gap-1 text-red-600 hover:text-red-700"
                          >
                            <Trash2 className="h-3 w-3" />
                            Ø­Ø°Ù
                          </Button>
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Add User Dialog */}
        <Dialog open={showAddUser} onOpenChange={setShowAddUser}>
          <DialogContent className="sm:max-w-[500px] max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</DialogTitle>
              <DialogDescription>
                Ù‚Ù… Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
              </DialogDescription>
            </DialogHeader>
            <form onSubmit={handleAddUser} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</Label>
                  <Input
                    id="username"
                    value={userForm.username}
                    onChange={(e) => setUserForm(prev => ({ ...prev, username: e.target.value }))}
                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                    required
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</Label>
                  <Input
                    id="email"
                    type="email"
                    value={userForm.email}
                    onChange={(e) => setUserForm(prev => ({ ...prev, email: e.target.value }))}
                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</Label>
                  <Input
                    id="phone"
                    type="tel"
                    value={userForm.phone}
                    onChange={(e) => setUserForm(prev => ({ ...prev, phone: e.target.value }))}
                    placeholder="01xxxxxxxxx"
                    required
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="nationalId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ *</Label>
                  <Input
                    id="nationalId"
                    value={userForm.nationalId}
                    onChange={(e) => setUserForm(prev => ({ ...prev, nationalId: e.target.value }))}
                    placeholder="14 Ø±Ù‚Ù…"
                    required
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</Label>
                  <Input
                    id="password"
                    type="password"
                    value={userForm.password}
                    onChange={(e) => setUserForm(prev => ({ ...prev, password: e.target.value }))}
                    placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                    required
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</Label>
                  <Input
                    id="confirmPassword"
                    type="password"
                    value={userForm.confirmPassword}
                    onChange={(e) => setUserForm(prev => ({ ...prev, confirmPassword: e.target.value }))}
                    placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                    required
                  />
                </div>
              </div>
              
              <div className="flex gap-3 pt-4">
                <Button type="button" variant="outline" onClick={() => setShowAddUser(false)}>
                  Ø¥Ù„ØºØ§Ø¡
                </Button>
                <Button type="submit">
                  Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>

        {/* Edit User Dialog */}
        <Dialog open={showEditUser} onOpenChange={setShowEditUser}>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</DialogTitle>
              <DialogDescription>
                Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
              </DialogDescription>
            </DialogHeader>
            <form onSubmit={handleEditUser} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="edit-username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</Label>
                <Input
                  id="edit-username"
                  value={editForm.username}
                  onChange={(e) => setEditForm(prev => ({ ...prev, username: e.target.value }))}
                  placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</Label>
                <Input
                  id="edit-email"
                  type="email"
                  value={editForm.email}
                  onChange={(e) => setEditForm(prev => ({ ...prev, email: e.target.value }))}
                  placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</Label>
                <Input
                  id="edit-phone"
                  type="tel"
                  value={editForm.phone}
                  onChange={(e) => setEditForm(prev => ({ ...prev, phone: e.target.value }))}
                  placeholder="01xxxxxxxxx"
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-nationalId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ *</Label>
                <Input
                  id="edit-nationalId"
                  value={editForm.nationalId}
                  onChange={(e) => setEditForm(prev => ({ ...prev, nationalId: e.target.value }))}
                  placeholder="14 Ø±Ù‚Ù…"
                  required
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <Button type="button" variant="outline" onClick={() => setShowEditUser(false)}>
                  Ø¥Ù„ØºØ§Ø¡
                </Button>
                <Button type="submit">
                  ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>

        {/* Delete User Dialog */}
        <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</AlertDialogTitle>
              <AlertDialogDescription>
                Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "{userToDelete?.username}"ØŸ
                <br />
                <span className="text-red-600">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.</span>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel onClick={() => setShowDeleteDialog(false)}>
                Ø¥Ù„ØºØ§Ø¡
              </AlertDialogCancel>
              <AlertDialogAction onClick={handleDeleteUser} className="bg-red-600 hover:bg-red-700">
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Role Assignment Dialog */}
        <Dialog open={showRoleDialog} onOpenChange={setShowRoleDialog}>
          <DialogContent className="sm:max-w-[600px] max-h-[80vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Shield className="h-5 w-5" />
                ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {selectedUserForRole?.username}
              </DialogTitle>
              <DialogDescription>
                ØªØ¹ÙŠÙŠÙ† ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <h4 className="font-medium mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                <div className="space-y-2">
                  {selectedUserForRole?.userRoles.map((userRole, index) => (
                    <div key={index} className="flex items-center justify-between p-2 border rounded">
                      <span>{userRole.role.description}</span>
                      <Badge className="bg-blue-100 text-blue-800">
                        {userRole.branch?.name || 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}
                      </Badge>
                    </div>
                  ))}
                </div>
              </div>
              
              <div>
                <h4 className="font-medium mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</h4>
                <div className="space-y-2">
                  {roles.map((role) => (
                    <div key={role.id} className="flex items-center justify-between p-2 border rounded hover:bg-gray-50">
                      <div>
                        <div className="font-medium">{role.name}</div>
                        <div className="text-sm text-gray-600">{role.description}</div>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          // This would assign the role
                        }}
                      >
                        ØªØ¹ÙŠÙŠÙ†
                      </Button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="flex gap-3 pt-4">
              <Button variant="outline" onClick={() => setShowRoleDialog(false)}>
                Ø¥Ù„ØºØ§Ø¡
              </Button>
              <Button onClick={handleAssignRole}>
                Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
              </Button>
            </div>
          </DialogContent>
        </Dialog>

        {/* Transfer User Dialog */}
        <Dialog open={showTransferDialog} onOpenChange={setShowTransferDialog}>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <ArrowRight className="h-5 w-5" />
                Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
              </DialogTitle>
              <DialogDescription>
                Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {userToTransfer?.username} Ø¥Ù„Ù‰ ÙØ±Ø¹ Ø¢Ø®Ø±
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <Label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</Label>
                <div className="p-2 border rounded">
                  <div className="font-medium">{userToTransfer?.username}</div>
                  <div className="text-sm text-gray-600">{userToTransfer?.email || userToTransfer?.phone}</div>
                </div>
              </div>
              
              <div>
                <Label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:</Label>
                <div className="p-2 border rounded">
                  <div className="font-medium">{getUserBranch(userToTransfer!)}</div>
                </div>
              </div>
              
              <div>
                <Label htmlFor="branch-select">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</Label>
                <Select value={selectedBranchForTransfer?.id || ''} onValueChange={(value) => {
                  const branch = getActiveBranches().find(b => b.id === value)
                  setSelectedBranchForTransfer(branch || null)
                }}>
                  <SelectTrigger>
                    <SelectValue placeholder="Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" />
                  </SelectTrigger>
                  <SelectContent>
                    {getActiveBranches().map((branch) => (
                      <SelectItem key={branch.id} value={branch.id}>
                        {branch.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              </div>
            </div>
            
            <div className="flex gap-3 pt-4">
              <Button variant="outline" onClick={() => setShowTransferDialog(false)}>
                Ø¥Ù„ØºØ§Ø¡
              </Button>
              <Button 
                onClick={handleTransferUser}
                disabled={!selectedBranchForTransfer}
              >
                Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  )
}